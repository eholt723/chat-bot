<script>
const chat = document.getElementById('chat');
const form = document.getElementById('f');
const input = document.getElementById('t');

function add(role, text){
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
  div.textContent = text || "";
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  add('user', text);
  const botDiv = add('bot', "");  // empty bubble to fill
  form.querySelector('button').disabled = true;

  try {
    const res = await fetch('/chat_stream', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: text})
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split("\n\n");
      buffer = parts.pop();
      for(const part of parts){
        if(part.startsWith("data: ")){
          const payload = JSON.parse(part.slice(6));
          if(payload.token){
            botDiv.textContent += payload.token;
            chat.scrollTop = chat.scrollHeight;
          }
          if(payload.error){
            botDiv.textContent = "Error: " + payload.error;
          }
        }
      }
    }
  } catch(err){
    botDiv.textContent = "Network error: " + err.message;
  } finally {
    form.querySelector('button').disabled = false;
    input.focus();
  }
});
</script>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Chatbot Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --card:#151822; --muted:#9aa3b2; --accent:#4b82ff; --border:#212638; --text:#e8eefc; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:800px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px;text-align:center}
    .stack{color:var(--muted);font-size:13px;text-align:center;margin-bottom:16px}
    .chat{background:var(--card);border:1px solid var(--border);border-radius:16px;height:62vh;overflow:auto;padding:16px}
    .msg{max-width:80%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.4;white-space:pre-wrap}
    .me{margin-left:auto;background:var(--accent);color:#fff}
    .bot{background:#131622;border:1px solid var(--border)}
    .typing{display:flex;gap:6px;margin:8px 0}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);opacity:.7;animation:b 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes b {0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-4px)}}
    form{display:flex;gap:8px;margin-top:12px}
    input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:#e8eefc}
    button{padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Live Chatbot Demo</h1>
    <div class="stack">Built with Python · Flask · VS Code · Cohere API · Render</div>

    <div id="chat" class="chat"></div>

    <form id="chat-form">
      <input id="chat-input" placeholder="Say hi…" autocomplete="off"/>
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const chat  = document.getElementById('chat');
    const form  = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');

    function add(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }
    function typingBubble(){
      const row = document.createElement('div');
      row.className = 'typing';
      row.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return row;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      input.value = '';
      add('user', text);
      const botDiv = add('bot', '');
      const bubble = typingBubble();
      form.querySelector('button').disabled = true;

      try{
        const res = await fetch('/chat_stream', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({message: text})
        });

        if(!res.ok || !res.body){
          const txt = await res.text().catch(()=> '');
          bubble.remove();
          botDiv.textContent = `Server error ${res.status}. ${txt.slice(0,200)}`;
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        let gotAny = false;

        while(true){
          const {done, value} = await reader.read();
          if(done) break;
          buffer += decoder.decode(value, {stream:true});

          const parts = buffer.split("\n\n");
          buffer = parts.pop();

          for(const part of parts){
            if(!part.startsWith("data: ")) continue;
            const jsonStr = part.slice(6).trim();
            if(jsonStr === "[DONE]") continue;

            let payload;
            try { payload = JSON.parse(jsonStr); } catch { continue; }

            if(payload.token){
              gotAny = true;
              botDiv.textContent += payload.token;
              chat.scrollTop = chat.scrollHeight;
            }
            if(payload.error){
              botDiv.textContent = "Error: " + payload.error;
            }
          }
        }

        bubble.remove();
        if(!gotAny && !botDiv.textContent){
          // safety net: ask the non-streaming endpoint to produce something
          const r2 = await fetch('/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({message: text})
          });
          const ct = r2.headers.get('content-type') || '';
          if (ct.includes('application/json')){
            const d2 = await r2.json().catch(()=>null);
            botDiv.textContent = d2 && d2.reply ? d2.reply : '(no reply)';
          } else {
            const t2 = await r2.text().catch(()=> '');
            botDiv.textContent = t2.slice(0,200) || '(no reply)';
          }
        }
      }catch(err){
        bubble.remove();
        botDiv.textContent = 'Network error: ' + err.message;
      }finally{
        form.querySelector('button').disabled = false;
        input.focus();
      }
    });
  });
  </script>
</body>
</html>

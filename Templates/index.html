<script>
document.addEventListener('DOMContentLoaded', () => {
  const chat = document.getElementById('chat');
  const form = document.getElementById('f');
  const input = document.getElementById('t');

  function add(role, text){
    const div = document.createElement('div');
    div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
    div.textContent = text || "";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    input.value = '';
    add('user', text);
    form.querySelector('button').disabled = true;

    try{
      const res = await fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: text})
      });

      const ct = res.headers.get('content-type') || '';
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        add('bot', `Server error ${res.status}. ${txt.slice(0,200)}`);
      } else if (!ct.includes('application/json')) {
        const txt = await res.text().catch(()=> '');
        add('bot', `Unexpected response (not JSON). First bytes:\n${txt.slice(0,200)}`);
      } else {
        const data = await res.json();
        if(!data.ok) add('bot', 'Error: ' + (data.error || 'unknown'));
        else add('bot', data.reply || '(no reply)');
      }
    }catch(err){
      add('bot', 'Network error: ' + err.message);
    }finally{
      form.querySelector('button').disabled = false;
      input.focus();
    }
  });
});
</script>

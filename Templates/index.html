<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Chatbot Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --card:#151822; --muted:#9aa3b2; --accent:#4b82ff; --border:#212638; --text:#e8eefc; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:800px;margin:24px auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px;text-align:center}
    .stack{color:var(--muted);font-size:13px;text-align:center;margin-bottom:16px}
    .chat{background:var(--card);border:1px solid var(--border);border-radius:16px;height:62vh;overflow:auto;padding:16px}
    .msg{max-width:80%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.4;white-space:pre-wrap}
    .me{margin-left:auto;background:var(--accent);color:#fff}
    .bot{background:#131622;border:1px solid var(--border)}
    form{display:flex;gap:8px;margin-top:12px}
    input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--text)}
    button{padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Live Chatbot Demo</h1>
    <div class="stack">Built with Python · Flask · VS Code · Cohere API · Render</div>

    <!-- Chat area -->
    <div id="chat" class="chat"></div>

    <!-- Input form -->
    <form id="chat-form">
      <input id="chat-input" placeholder="Say hi…" autocomplete="off"/>
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Put the script at the very end + use DOMContentLoaded just to be extra safe -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Robust selectors (IDs + fallbacks)
    const chat   = document.getElementById('chat')       || document.querySelector('#chat');
    const form   = document.getElementById('chat-form')  || document.querySelector('form');
    const input  = document.getElementById('chat-input') || document.querySelector('input');

    if (!chat || !form || !input) {
      console.error('Missing DOM elements. Expected #chat, #chat-form, #chat-input.');
      return;
    }

    function add(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      input.value = '';
      add('user', text);
      form.querySelector('button').disabled = true;

      try{
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({message: text})
        });

        const ct = res.headers.get('content-type') || '';
        if (!res.ok) {
          const txt = await res.text().catch(()=> '');
          add('bot', `Server error ${res.status}. ${txt.slice(0,200)}`);
        } else if (!ct.includes('application/json')) {
          const txt = await res.text().catch(()=> '');
          add('bot', `Unexpected response (not JSON). First bytes:\n${txt.slice(0,200)}`);
        } else {
          const data = await res.json();
          if(!data.ok) add('bot', 'Error: ' + (data.error || 'unknown'));
          else add('bot', data.reply || '(no reply)');
        }
      }catch(err){
        add('bot', 'Network error: ' + err.message);
      }finally{
        form.querySelector('button').disabled = false;
        input.focus();
      }
    });
  });
  </script>
</body>
</html>

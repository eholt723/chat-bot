<script>
document.addEventListener('DOMContentLoaded', () => {
  const chat  = document.getElementById('chat');
  const form  = document.getElementById('chat-form') || document.getElementById('f');
  const input = document.getElementById('chat-input') || document.getElementById('t');

  function add(role, text){
    const div = document.createElement('div');
    div.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
    div.textContent = text || "";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    input.value = '';
    add('user', text);
    form.querySelector('button').disabled = true;
    try{
      const res = await fetch('/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message: text})
      });
      const data = await res.json().catch(()=>null);
      add('bot', data && data.ok ? (data.reply || '(no reply)') :
                   'Error: ' + (data && data.error ? data.error : res.status));
    }catch(err){
      add('bot', 'Network error: ' + err.message);
    }finally{
      form.querySelector('button').disabled = false;
      input.focus();
    }
  });
});
</script>
